<!DOCTYPE html>
<html>
<head>
    <title>noteMe: Prihlásenie</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" media="screen" href="@{'/public/stylesheets/normalize.min.css'}">
    <link rel="stylesheet" media="screen" href="@{'/public/stylesheets/noteMe-dark/jquery-ui-1.9.0.custom.css'}">
    <link rel="stylesheet" media="screen" href="@{'/public/stylesheets/main.css'}">
    <link rel="shortcut icon" type="image/png" href="@{'/public/images/favicon.png'}">
    <script src="@{'/public/javascripts/modernizr-2.6.1.min.js'}" type="text/javascript"></script>
    <script src="@{'/public/javascripts/jquery-1.8.2.js'}" type="text/javascript"></script>
    <script src="@{'/public/javascripts/jquery-ui-1.9.0.custom.js'}" type="text/javascript"></script>
</head>
<body id="section-login">
<div id="all-wrapper">
    <div class="noise-dark" style="height:32px;"></div>
    <div class="seam-top"></div>
    <div class="content">
        <img src="@{'/public/images/logo-login.png'}" alt="noteMe" width="168" height="168">
        #{form @App.authenticate(), id:'lrform'}
            <h1>Vitajte!</h1>
            <label for="email">e-mail:</label>
            <input type="email" placeholder="e-mail" id="email" name="email" title="Zadajte svoj e-mail"><br>
            <div style="display:none;" class="registration-fields">
                <label for="name">meno:</label>
                <input type="text" placeholder="meno" id="name" name="name" disabled="disabled" title="Zadajte meno (voliteľná položka)"><br>
            </div>
            <label for="passwd">heslo:</label>
            <input type="password" placeholder="heslo" id="passwd" name="password" title="Zadajte svoje heslo"><br>
            <div style="display:none;" class="registration-fields">
                <label for="passwdcheck">potvrdenie hesla:</label>
                <input type="password" placeholder="potvrdenie hesla" id="passwdcheck" name="passwordcheck" disabled="disabled" title="Zopakujte svoje nové heslo"><br>
            </div>
            <div style="position:relative;left:14px;text-align: right;">
                <input type="submit" value="Prihlásiť" id="submit">
            </div>
            <p class="small" id="go-registration"><br>
                Ak ešte nemáte noteMe účet, <a href="#registration">zaregistrujte sa</a>.
            </p>
        #{/form}
    </div>

    <footer class="noise-green">
    <div class="seam-bottom"></div>
    &copy;2012 noteMe
</footer>

</div>
<script type="text/javascript">
$(function(){

    var defaultTooltips = function(){
        $("[title]").each(function(){
            try {
                $(this).tooltip("destroy");
            } catch(e) {
                //ignore
            }
        });
        $("[title]").tooltip();
    };
    defaultTooltips();

    function jQnoanim(action) {
        var fx = jQuery.fx.off,
            returnValue;
        jQuery.fx.off = true;
        returnvalue = action();
        jQuery.fx.off = fx;
        return returnValue;
    }

    $("#submit").button();

    $(window).bind('hashchange', function (event,noanim) {
        var action = window.location.hash.slice(1),
            returnValue;
        if (action){
            if (noanim) {
                return jQnoanim(navActions[action]);
            } else {
                return navActions[action]();
            }
        } else if(action === "") {
            if (noanim) {
                return jQnoanim(navActions["_default"]);
            } else {
                return navActions["_default"]();
            }
        }
    });

    var navActions = {
        registration: function () {
            $(".registration-fields").slideDown();
            $("*[disabled]").removeAttr("disabled");
            $("#submit").attr("value","Registrovať");
            $("#go-registration").fadeOut();
            $("#lrform").attr("action","/registration");
            return false;
        },
        _default: function() {
            $(".registration-fields").slideUp();
            $("*[disabled]").attr("disabled");
            $("#submit").attr("value","Prihlásiť");
            $("#go-registration").fadeIn();
            $("#lrform").attr("action","/login");
            return false;
        }
    };

    // vynut kontrolu hash casti url po nacitani
    $(window).triggerHandler("hashchange",true);


    // label namiesto placeholderov, ak ich prehliadač nepodporuje
    if(Modernizr.input.placeholder){
        $("input").each(function() {
            if ( $(this).attr("placeholder") !=="" ) {
                $('label[for="'+$(this).attr("id")+'"]').hide();
            }
        });
    }

    $("#lrform").submit(function(event) {
        event.preventDefault();
        $.ajax({
            type : "POST",
            url : $(this).attr("action"),
            data : $(this).serialize(),
            success : function(data){
                console.log(data);
                console.log(data.next);
                window.location.assign(data.next);
                //$(location).attr("href",data.next);
            },
            error : function(err){
                console.log(err);
                var resp = $.parseJSON(err.responseText),
                    tooltips, globalTooltip;
                tooltips = $("input[type='text'], input[type='password'], input[type='email']").tooltip({
                    content: function() {
                        if(resp && resp[$(this).attr("name")]) {
                            return resp[$(this).attr("name")][0];
                        }
                    },
                    open: function(){
                        var self = $(this);
                        setTimeout(function(){self.tooltip("close");}, 5000);
                    },
                    close: function(){
                        $(this).tooltip("destroy");
                        defaultTooltips();
                    },
                    tooltipClass: "ui-state-error"
                });
                tooltips.tooltip("open");
                if(resp[""]){
                    globalTooltip = $("img").tooltip({
                        content: resp[""][0],
                        tooltipClass: "ui-state-error",
                        items:"img",
                        position:{my:"center top+10", at:"center+15 bottom"},
                        close: function(){
                            $(this).tooltip("destroy");
                        },
                        open: function(){
                            var self = $(this);
                            setTimeout(function(){self.tooltip("close");}, 5000);
                        }
                    });
                    globalTooltip.tooltip("open");
                }
            }
        });
    });


});
</script>
</body>
</html>